<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>栄養ログ & 習慣スコア</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main-blue: #3498db; --bg-gray: #f4f7f9; --accent: #e67e22; --score-green: #2ecc71; }
        body { font-family: sans-serif; background: var(--bg-gray); margin: 0; padding: 0; color: #333; font-size: 14px; }
        
        /* 固定ヘッダーエリア */
        .sticky-header { 
            position: -webkit-sticky; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            background: var(--bg-gray);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
        }

        #chart-row { display: flex; gap: 5px; width: 100%; margin-bottom: 8px; }
        .chart-box { flex: 1; min-width: 0; background: white; padding: 6px 4px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .canvas-container { position: relative; width: 100%; aspect-ratio: 1 / 1; }

		/* スコア表示エリアのベース（ボーダー色はJSで制御するため削除） */
		.score-display {
		    background: white;
		    padding: 8px;
		    border-radius: 8px;
		    text-align: center;
		    font-weight: bold;
		    transition: all 0.3s ease; /* 色の変化を滑らかに */
		}

		/* 点数ごとの色定義 */
		.score-red { color: #e74c3c; border-bottom: 4px solid #e74c3c; }
		.score-orange { color: #e67e22; border-bottom: 4px solid #e67e22; }
		.score-green { color: #27ae60; border-bottom: 4px solid #27ae60; }

        .container { padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 12px; }
        h2 { font-size: 0.9rem; margin: 0 0 10px 0; border-left: 4px solid var(--main-blue); padding-left: 10px; }

        .target-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 10px; }
        .target-input-box { font-size: 0.7rem; text-align: center; }
        .target-input-box input { width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: right; box-sizing: border-box; }

        .item-row { border-bottom: 1px solid #eee; padding: 10px 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .item-name { font-weight: bold; font-size: 0.85rem; }
        
        .info-btn { background: #eee; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer; color: #666; }
        .health-info { display: none; font-size: 0.75rem; background: #fff9e6; padding: 8px; border-radius: 4px; margin: 5px 0; color: #856404; line-height: 1.4; }

        .g-input-wrap { display: flex; align-items: center; gap: 8px; }
        .g-input-wrap input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: right; font-size: 1rem; }

        .choice-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .choice-group label { flex: 1; min-width: 60px; cursor: pointer; }
        .choice-group input { display: none; }
        .choice-group span { display: block; background: #f0f0f0; padding: 10px 2px; text-align: center; border-radius: 6px; font-size: 0.75rem; color: #555; }
        .choice-group input:checked + span { background: var(--main-blue); color: white; font-weight: bold; }
        .B-choice input:checked + span { background: var(--accent); }

        .upload-btn { background: #27ae60; color: white; border: none; width: 100%; padding: 16px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1.1rem; }

        .config-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div id="chart-row">
        <div class="chart-box"><div class="canvas-container"><canvas id="chart-protein"></canvas></div><div style="font-size:0.65rem; font-weight:bold;">たんぱく質</div><div id="d-protein" style="font-size:0.6rem;"></div></div>
        <div class="chart-box"><div class="canvas-container"><canvas id="chart-fat"></canvas></div><div style="font-size:0.65rem; font-weight:bold;">脂質</div><div id="d-fat" style="font-size:0.6rem;"></div></div>
        <div class="chart-box"><div class="canvas-container"><canvas id="chart-carbs"></canvas></div><div style="font-size:0.65rem; font-weight:bold;">炭水化物</div><div id="d-carbs" style="font-size:0.6rem;"></div></div>
        <div class="chart-box"><div class="canvas-container"><canvas id="chart-siso"></canvas></div><div style="font-size:0.65rem; font-weight:bold;">大豆イソフラボン</div><div id="d-siso" style="font-size:0.6rem;"></div></div>
    </div>
    <div class="score-display">
        習慣達成スコア: <span id="habit-score">0</span> / 100 点
    </div>
</div>

<div class="container">
    <div class="card">
        <h2>GAS ウェブアプリURL設定</h2>
        <input id="gas-url-input" class="config-input" placeholder="https://script.google.com/macros/s/.../exec">
        <p style="font-size:0.7rem; color:#888; margin-top:5px;">※URLはブラウザ内にのみ保存されます。</p>
    </div>

    <div class="card">
        <h2>基準値（目標量）の設定</h2>
        <div class="target-grid" id="target-inputs">
            <div class="target-input-box">たんぱく質[g]<input type="number" data-key="protein" value="65"></div>
            <div class="target-input-box">脂質[g]<input type="number" data-key="fat" value="60"></div>
            <div class="target-input-box">炭水化物[g]<input type="number" data-key="carbs" value="300"></div>
            <div class="target-input-box">大豆イソフラボン[mg]<input type="number" data-key="siso" value="70"></div>
        </div>
    </div>

    <div class="card">
        <h2>A：計算項目</h2>
        <div id="A-list"></div>
    </div>

    <div class="card">
        <h2>B：記録項目</h2>
        <div id="B-list"></div>
    </div>

    <button id="btn-upload" class="upload-btn" onclick="uploadToGAS()">GASへ送信 & リセット</button>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxHUe1CVM7QdS6p-ged99y7k7QGzppBx644_yHYf-PmBR-stR-kuU-9KTKG1M7ptlBXzg/exec";

const foodConfigs = [
    { id: 'bean',     name: '豆', guide: '100g単位', info: '植物性たんぱく質と食物繊維が豊富です。',           p: 15,   f: 6,   c: 30,  i: 110, type: 'g' },
    { id: 'meat',     name: '肉類', guide: '100g単位', info: '動物性たんぱく質の主役。部位により脂質が変動。', p: 20,   f: 12,  c: 0,   i: 0, type: 'g' },
    { id: 'natto',    name: '納豆', guide: '1パック45g', info: '発酵食品。血液サラサラ成分ナットウキナーゼ。', p: 16.5, f: 10,  c: 12,  i: 35, type: 'radio', opts: [{l:'なし',v:0},{l:'たべた',v:45}] },
//    { id: 'yogurt',   name: 'ヨーグルト', guide: '100g単位', info: '乳酸菌で腸内環境を整えます。',             p: 3.5,  f: 3,   c: 5,   i: 0, type: 'g' },
    { id: 'gyogurt',  name: 'ギリシャヨーグルト', guide: '100g単位', info: '通常の3倍のたんぱく質、低脂質。',  p: 10,   f: 0.2, c: 4,   i: 9, type: 'g' },
    { id: 'kinako',   name: 'きな粉', guide: '100g単位', info: '大豆を丸ごと粉末に。大豆イソフラボン。',       p: 35,   f: 23,  c: 30,  i: 200, type: 'g' },
    { id: 'milk',     name: '牛乳', guide: '100g単位', info: '吸収の良いカルシウム源。',                       p: 3.3,  f: 3.8, c: 4.8, i: 0, type: 'g' },
    { id: 'smilk',    name: '豆乳', guide: '100g単位', info: 'コレステロールゼロの植物性ミルク。',             p: 3.6,  f: 2,   c: 1.8, i: 38, type: 'g' },
    { id: 'cheese',   name: 'チーズ', guide: '20g（1個分）', info: 'たんぱく質と脂質が凝縮された食品。',       p: 25,   f: 25,  c: 1.5, i: 0, type: 'radio', opts: [{l:'なし',v:0},{l:'たべた',v:20}] },
    { id: 'shirasu',  name: 'しらす大匙1', guide: '約5g', info: '小魚を丸ごと。カルシウム補給に。',            p: 23,   f: 1,   c: 0,   i: 0, type: 'radio', opts: [{l:'なし',v:0},{l:'たべた',v:5}] },
    { id: 'fish',     name: '魚介類', guide: '切り身1切れ目安', info: '良質な油（DHA/EPA）が含まれます。',     p: 20,   f: 8,   c: 0,   i: 0, type: 'radio', opts: [{l:'0g',v:0},{l:'50g',v:50},{l:'100g',v:100}] },
    { id: 'egg',      name: 'たまご', guide: '1個50g', info: '全ての必須アミノ酸を含む完全栄養食。',           p: 12,   f: 10,  c: 0.4, i: 0, type: 'radio', opts: [{l:'0個',v:0},{l:'0.5個',v:25},{l:'1個',v:50}] }
];

// B構成（野菜・海藻・きのこ・オイルがスコア対象）
const bConfigs = [
    { name: '豆類', opts: ['×','○','◎'], score: true },
    { name: '魚介類', opts: ['×','○','◎'], score: true },
    { name: '肉(魚介類)', opts: ['×','○','◎'], score: true },
    { name: '穀類', opts: ['×','○','◎'], score: true },
    { name: '野菜', opts: ['×','○','◎'], score: true },
    { name: '海藻類', opts: ['×','○','◎'], score: true },
    { name: 'きのこ', opts: ['×','○','◎'], score: true },
    { name: '乳製品', opts: ['×','○','◎'], score: true },
    { name: 'たまご', opts: ['×','○','◎'], score: true },
    { name: 'オイル', opts: ['×','○','◎'], score: true },
    { name: '糖質(こぶし3個以内)', opts: ['できてない','できた'] },
    { name: '水分(1.2L以上)', opts: ['できてない','できた'] },
    { name: '咀嚼量(ペースト状まで)', opts: ['できてない','できた'] },
    { name: '食べ方(糖質から食べない)', opts: ['できてない','できた'] },
    { name: '酒', opts: ['飲んでない','飲んだ'], score: true },
    { name: 'お菓子', opts: ['食べてない','食べた'], score: true },
    { name: '便状態', opts: ['なし','普通','硬い','柔らかい'] },
    { name: '便色', opts: ['なし','黄茶色','茶色','黒茶'] }
];

const configs = {
    protein: { color: '#3498db', unit: 'g' },
    fat:     { color: '#f1c40f', unit: 'g' }, 
    carbs:   { color: '#1abc9c', unit: 'g' }, 
    siso:    { color: '#9b59b6', unit: 'mg' }
};

const charts = {};

function init() {
    const aList = document.getElementById('A-list');
    foodConfigs.forEach(f => {
        let inputHtml = f.type === 'g' 
            ? `<div class="g-input-wrap"><input type="number" data-id="${f.id}" value="0"> g</div>`
            : `<div class="choice-group">${f.opts.map((o,i)=>`<label><input type="radio" name="${f.id}" value="${o.v}" ${i===0?'checked':''}><span>${o.l}</span></label>`).join('')}</div>`;
        
        aList.innerHTML += `<div class="item-row"><div class="item-header"><span class="item-name">${f.name}</span><button class="info-btn" onclick="toggleInfo('${f.id}')">i</button></div><div id="info-${f.id}" class="health-info">${f.info}</div>${inputHtml}</div>`;
    });

    const bList = document.getElementById('B-list');
    bConfigs.forEach((b,idx) => {
        bList.innerHTML += `<div class="item-row"><div class="item-name">${b.name}</div><div class="choice-group B-choice">${b.opts.map((o,i)=>`<label><input type="radio" name="b-${idx}" value="${o}" ${i===0?'checked':''}><span>${o}</span></label>`).join('')}</div></div>`;
    });

    ['protein','fat','carbs', 'siso'].forEach(id => {
        charts[id] = new Chart(document.getElementById(`chart-${id}`).getContext('2d'), {
            type: 'doughnut',
            data: { datasets: [{ data: [0, 100], backgroundColor: [configs[id].color, '#eee'], borderWidth: 0 }] },
            options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } }, animation: false }
        });
    });
}

function toggleInfo(id) {
    const el = document.getElementById(`info-${id}`);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function update() {
    let totals = {protein: 0, fat: 0, carbs: 0, siso: 0};
    let targets = {};
    document.querySelectorAll('#target-inputs input').forEach(i => targets[i.dataset.key] = parseFloat(i.value) || 1);

    // A項目計算
    foodConfigs.forEach(f => {
        let weight = f.type === 'g' ? parseFloat(document.querySelector(`[data-id="${f.id}"]`).value) || 0 : parseFloat(document.querySelector(`input[name="${f.id}"]:checked`).value) || 0;
        totals.protein += (f.p * weight) / 100;
        totals.fat += (f.f * weight) / 100;
        totals.carbs += (f.c * weight) / 100;
        totals.siso += (f.i * weight) / 100;
    });

    // B項目スコア計算 (◎=8, ○=4, ×=0)
    let hScore = 0;
    bConfigs.forEach((b, idx) => {
        if(b.score) {
            const val = document.querySelector(`input[name="b-${idx}"]:checked`).value;
            if(val === '◎') hScore += 8;
            else if(val === '○') hScore += 4;
            else if(val === '飲んでない') hScore += 10;
            else if(val === '食べてない') hScore += 10;
        }
    });
    
    const scoreEl = document.getElementById('habit-score');
	const scoreBox = scoreEl.parentElement; // .score-displayを取得

	// 点数表示の更新
	scoreEl.innerText = hScore;

	// クラスのリセットと付与
	scoreBox.classList.remove('score-red', 'score-orange', 'score-green');
	if (hScore <= 39) {
	    scoreBox.classList.add('score-red');
	} else if (hScore <= 79) {
	    scoreBox.classList.add('score-orange');
	} else {
	    scoreBox.classList.add('score-green');
	}
	
    // グラフ反映
    ['protein','fat','carbs', 'siso'].forEach(id => {
        const ratio = totals[id] / targets[id];
        charts[id].data.datasets[0].data = [Math.min(ratio * 100, 100), Math.max(0, 100 - ratio * 100)];
        charts[id].update();
        //document.getElementById(`d-${id}`).innerHTML = `<strong>${(ratio*100).toFixed(0)}%</strong><br>${totals[id].toFixed(1)}g`;
        document.getElementById(`d-${id}`).innerHTML = `${totals[id].toFixed(1)}${configs[id].unit}`;
    });
    saveState();
}

// 食事内容とB項目のみを初期化する関数
function resetInputs() {
    // A項目のg入力を0に
    document.querySelectorAll('[data-id]').forEach(input => input.value = 0);
    
    // A・B項目のラジオボタンを一番左（初期値）に
    const groups = {};
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        if (!groups[radio.name]) {
            radio.checked = true; // 各グループの最初の要素を選択状態にする
            groups[radio.name] = true;
        }
    });
    
    // 状態を保存してグラフを更新
    update();
}

// フルバックアップ保存
function saveState() {
    const state = {
        gasUrl: document.getElementById('gas-url-input').value,
        targets: Array.from(document.querySelectorAll('#target-inputs input')).map(i => ({k:i.dataset.key, v:i.value})),
        g: Array.from(document.querySelectorAll('[data-id]')).map(i => ({id: i.dataset.id, v: i.value})),
        r: Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(i => ({n: i.name, v: i.value}))
    };
    localStorage.setItem('nutri_full_backup', JSON.stringify(state));
}

// フルバックアップ復元
function loadState() {
    const saved = JSON.parse(localStorage.getItem('nutri_full_backup'));
    if(!saved) return;
    if(saved.gasUrl) document.getElementById('gas-url-input').value = saved.gasUrl;
    if(saved.targets) saved.targets.forEach(i => { const el = document.querySelector(`input[data-key="${i.k}"]`); if(el) el.value = i.v; });
    if(saved.g) saved.g.forEach(i => { const el = document.querySelector(`[data-id="${i.id}"]`); if(el) el.value = i.v; });
    if(saved.r) saved.r.forEach(i => { const el = document.querySelector(`input[name="${i.n}"][value="${i.v}"]`); if(el) el.checked = true; });
}

async function uploadToGAS() {
    const url = document.getElementById('gas-url-input').value;
    if(!url) { alert("GASのURLを設定してください。"); return; }

    const btn = document.getElementById('btn-upload');
    btn.disabled = true;
    btn.innerText = "送信中...";

    // 送信データの作成
    const results = {
        date: new Date().toLocaleString(),
        habit_score: document.getElementById('habit-score').innerText,
        p_total: document.getElementById('d-protein').innerText.replace('<br>',' '),
        f_total: document.getElementById('d-fat').innerText.replace('<br>',' '),
        c_total: document.getElementById('d-carbs').innerText.replace('<br>',' '),
        i_total: document.getElementById('d-siso').innerText.replace('<br>',' ')
    };
    
    // --- 【追加】A項目の入力値を収集 ---
    foodConfigs.forEach(f => {
        let val = 0;
        if(f.type === 'g') {
            val = document.querySelector(`[data-id="${f.id}"]`).value;
        } else {
            // ラジオボタンの場合は選択されているラベル（または値）を取得
            const checked = document.querySelector(`input[name="${f.id}"]:checked`);
            val = checked ? checked.parentElement.innerText : 0;
        }
        results["A_" + f.name] = val; // スプレッドシートで判別しやすいよう接頭辞を付与
    });

    // B項目の収集
    document.querySelectorAll('.B-choice input:checked').forEach(i => {
        const label = i.closest('.item-row').querySelector('.item-name').innerText;
        results[label] = i.value;
    });

    try {
        await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(results) });
        alert("送信完了！内容をリセットしました。");
        resetInputs();
    } catch(e) {
        alert("送信エラー。");
    } finally {
        btn.disabled = false;
        btn.innerText = "GASへ送信 (バックアップ保持)";
    }
}

document.addEventListener('input', update);
document.addEventListener('change', update);
window.onload = () => { init(); loadState(); update(); };
</script>
</body>
</html>